pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code from Git...'
                checkout([$class: 'GitSCM', branches: [[name: '*/master']],
			extensions: [],
			userRemoteConfigs: [[url: 'https://github.com/DaliDevops/MyProject.git']]])
            }
        }

        stage('Build') {
            steps {
                echo 'Building Angular project...'
                sh 'npm install'
                sh 'npm run test'
                sh 'npm run build'
                sh 'npm audit fix'
                sh 'ng serve --host 192.168.2.55 --port 4200'
            }
        }
        stage('Deploy') {
            steps {
                withCredentials ([usernamePassword(credentialsId: 'github_credentials', usernameVariable: 'DaliDevops', passwordVariable: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDOoFUpPdrEMXPgYMImU3Q4W7vWZtz7Lx379T3zcQO3AIK61MT1wuOBnNgc1zLlsO+/3xWmgOx3dcQfFi9PBRyHu2LNLjssrRbIP92Cl8nEoI+Hl3a5G/83YZWcfJlXRU/grJ12CrjV4pu5RvRqfpTvj84+nq5mnCeRn3A6c3cHC2ALFb/sz+yzJ3sVFkVhVMmqkRg3jVbBTsKWgXo05BytMnvsAdpTX/FULhrCBUtFlpQKP+m3oLZdkQKSMw9tZixhyMYzb7Jf37PFc8lDZfhZ8WNZkC/j99Nj5DLZw7r4sKujIjoYF8yxzH2tnFLfEiaspg7l5yemaChYO1S70kq56LPOSlfstpZc3L/2eL3+LLCS4uTh+iL4iI/1MYbbY3WR+Q1BQ3yamknnvzqJzKmDGTwg0sOC3wvUKub88q/EVoE69/h+mCbLdNCm4T3kKLutpv5A51VOijUh1Do0frB2pE3ob0d9X6dX6DT9XCxJuTnc0NtUmb3iAyfO9dH27dz0UFHKGF6ZNGyIqMJzd/0fFJFdFSe7tJIbp29vEPHNnURJzdtbclZPTP+zz1GVjwIo8LSBVYxlqGMrluEx43hY2NnGuCVrkr6IA0irB8iOP/QSplZZtbrXZftp7B56eg7lr6DHLXXl2gZwaRRKpe7TfajQCY0paPyE/GpgYsbwlw== dali2008fr@hotmail.fr')])
{     
                sh '''git config --global user.email "dali2008fr@hotmail.fr" 
                      git config --global user.name "DaliDevops"
                      git init 
                      git add .
                      git commit -m "Jenkins deployment"
                      git push https://${DaliDevops}:${ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDOoFUpPdrEMXPgYMImU3Q4W7vWZtz7Lx379T3zcQO3AIK61MT1wuOBnNgc1zLlsO+/3xWmgOx3dcQfFi9PBRyHu2LNLjssrRbIP92Cl8nEoI+Hl3a5G/83YZWcfJlXRU/grJ12CrjV4pu5RvRqfpTvj84+nq5mnCeRn3A6c3cHC2ALFb/sz+yzJ3sVFkVhVMmqkRg3jVbBTsKWgXo05BytMnvsAdpTX/FULhrCBUtFlpQKP+m3oLZdkQKSMw9tZixhyMYzb7Jf37PFc8lDZfhZ8WNZkC/j99Nj5DLZw7r4sKujIjoYF8yxzH2tnFLfEiaspg7l5yemaChYO1S70kq56LPOSlfstpZc3L/2eL3+LLCS4uTh+iL4iI/1MYbbY3WR+Q1BQ3yamknnvzqJzKmDGTwg0sOC3wvUKub88q/EVoE69/h+mCbLdNCm4T3kKLutpv5A51VOijUh1Do0frB2pE3ob0d9X6dX6DT9XCxJuTnc0NtUmb3iAyfO9dH27dz0UFHKGF6ZNGyIqMJzd/0fFJFdFSe7tJIbp29vEPHNnURJzdtbclZPTP+zz1GVjwIo8LSBVYxlqGMrluEx43hY2NnGuCVrkr6IA0irB8iOP/QSplZZtbrXZftp7B56eg7lr6DHLXXl2gZwaRRKpe7TfajQCY0paPyE/GpgYsbwlw== dali2008fr@hotmail.fr}@github.com/DaliDevops/MyProject.git HEAD:master'''
}

            }
        }
}
post {
   success {
     script {
        sh 'echo "Deployment successfull"'
        //Send a notification via email
         }
      }
  }
}
